name: Auto Release

on:
  push:
    branches: [main]
    paths:
      - 'plugins/**'
      - '.claude-plugin/marketplace.json'

jobs:
  detect-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed plugins and create tags
        run: |
          PREV_SHA=$(git rev-parse HEAD~1 2>/dev/null || echo "")
          if [ -z "$PREV_SHA" ]; then
            echo "First commit, skipping tag creation"
            exit 0
          fi

          TAGS_CREATED=0

          for plugin_dir in plugins/*/; do
            plugin_name=$(basename "$plugin_dir")

            # Check if this plugin had changes
            if git diff --name-only "$PREV_SHA" HEAD -- "$plugin_dir" | grep -q .; then
              version=$(jq -r '.version' "$plugin_dir/.claude-plugin/plugin.json")
              tag="${plugin_name}-v${version}"

              # Only create tag if it doesn't exist
              if ! git rev-parse "$tag" >/dev/null 2>&1; then
                echo "ðŸ·ï¸ Creating tag: $tag"
                git tag "$tag" -m "Release $plugin_name v$version"
                TAGS_CREATED=$((TAGS_CREATED + 1))
              else
                echo "â­ï¸ Tag $tag already exists, skipping"
              fi
            fi
          done

          if [ "$TAGS_CREATED" -gt 0 ]; then
            git push origin --tags
            echo "âœ… Created $TAGS_CREATED new tag(s)"
          else
            echo "No new tags needed"
          fi

      - name: Create GitHub release for new tags
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PREV_SHA=$(git rev-parse HEAD~1 2>/dev/null || echo "")
          if [ -z "$PREV_SHA" ]; then
            exit 0
          fi

          for plugin_dir in plugins/*/; do
            plugin_name=$(basename "$plugin_dir")

            if git diff --name-only "$PREV_SHA" HEAD -- "$plugin_dir" | grep -q .; then
              version=$(jq -r '.version' "$plugin_dir/.claude-plugin/plugin.json")
              tag="${plugin_name}-v${version}"

              # Check if release already exists
              if ! gh release view "$tag" >/dev/null 2>&1; then
                echo "ðŸ“¦ Creating release: $tag"

                # Generate changelog from recent commits
                CHANGELOG=$(git log --oneline "$PREV_SHA"..HEAD -- "$plugin_dir" | head -20)

                gh release create "$tag" \
                  --title "$plugin_name v$version" \
                  --notes "## Changes

${CHANGELOG}

---
Install: \`/plugin install ${plugin_name}@izteam\`"
              fi
            fi
          done
